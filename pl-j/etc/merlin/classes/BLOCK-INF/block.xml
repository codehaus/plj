<?xml version="1.0"?>

<!--
	The container definition for tests and developement.
	It starts up a FEBE channel on port 1984 and a PostgreSQL typemapper with
	some configured datatypes, a java executor with a filesystem classloader
	the glue and a brand new log4j adapter service.

	Start merlin and have fun!

-->

<container name="pl-j-test">

	<classloader>
		<classpath>
			<repository>
				<resource 
					id="avalon-framework:avalon-framework-impl" 
					version="4.1.5"/>

				<resource 
					id="avalon-framework:avalon-framework-api" 
					version="4.1.5"/>

				<resource
					id="cornerstone-sockets:cornerstone-sockets-api" 
					version="1.0"/>
				<resource 
					id="cornerstone-sockets:cornerstone-sockets-impl" 
					version="1.0"/>
				<resource
					id="excalibur-thread:excalibur-thread" 
					version="1.1.1"/>
				<resource
					id="excalibur-collections:excalibur-collections" 
					version="1.0"/>
				<resource
					id="excalibur:excalibur-threadcontext" 
					version="1.0"/>
				<resource
					id="excalibur-pool:excalibur-pool" 
					version="1.0"/>
				<resource
					id="log4j:log4j" 
					version="1.2.8"/>
				<resource
					id="commons-beanutils:commons-beanutils" 
					version="1.6.1"/>
				<resource
					id="commons-collections:commons-collections" 
					version="3.0"/>
				<resource
					id="commons-logging:commons-logging" 
					version="1.0.3"/>


				<resource 
					id="pl-j:pl-j-api" 
					version="0.0.2"/>
				<resource
					id="pl-j:pl-j-javaexecutor"
					version="0.0.2"/>
				<resource
					id="pl-j:pl-j-febe"
					version="0.0.2"/>
				<resource
					id="pl-j:pl-j-postgres"
					version="0.0.2"/>
				<resource
					id="pl-j:pl-j-glue"
					version="0.0.2"/>
				<resource
					id="pl-j:pl-j-tools"
					version="0.0.2"/>

			</repository>
		</classpath>
	</classloader>

	<component
		name="typemapper"
		class="org.pgj.typemapping.postgres.PostgresTypeMapper">
		<configuration>
			<map>
				<type db="int4" class="org.pgj.typemapping.postgres.PGSmallInt"/>
				<type db="varchar" class="org.pgj.typemapping.postgres.PGVarchar"/>
			</map>
			<backmap>
				<type class="java.lang.Integer" type="int4"/>
				<type class="java.lang.String" type="varchar"/>
			</backmap>
			
		</configuration>
		<categories priority="DEBUG">
			<category name="/typemapper"/>
		</categories>
	</component>

	<component
		name="channel"
		class="org.plj.chanells.febe.FEBEChannel">
		<configuration>
			<database-encoding>en_US</database-encoding>
			<passed-encoding>en_US</passed-encoding>
			<port>1984</port>
			<socket-factory-name>plain</socket-factory-name>
		</configuration>
		<dependencies>
			<dependency key="socket-manager" source="socketmanager"/>
			<dependency key="type-mapper" source="typemapper"/>
		</dependencies>
		<categories priority="DEBUG">
			<category name="/channel"/>
		</categories>
	</component>

	<component
		name="socketmanager"
		class="org.apache.avalon.cornerstone.blocks.sockets.DefaultSocketManager">
		<configuration>
			<server-sockets>
				<factory name="plain"
					class="org.apache.avalon.cornerstone.blocks.sockets.DefaultServerSocketFactory" />
			</server-sockets>
			<client-sockets>
				<factory name="plain"
					class="org.apache.avalon.cornerstone.blocks.sockets.DefaultSocketFactory" />
			</client-sockets>
		</configuration>
		<categories priority="DEBUG">
			<category name="/socketmanager"/>
		</categories>
	</component>

	<component
		name="classloader"
		class="org.pgj.tools.classloaders.impl.FSClassLoader">
		<configuration>
			<root>/tmp/plj-tests/</root>
		</configuration>
		<categories priority="DEBUG">
			<category name="/classloader"/>
		</categories>
	</component>

	<component
		name="executor"
		class="org.pgj.jexec.JavaExecutor">
		<dependencies>
			<dependency key="classloader" source="classloader"/>
			<dependency key="tuple-mapper" source="tuplemapper"/>
		</dependencies>
		<configuration>
			<tempDir>/tmp/</tempDir>
		</configuration>
		<categories priority="DEBUG">
			<category name="/executor"/>
		</categories>
	</component>

	<component
		name="glue"
		class="org.pgj.glue.Glue">
		<dependencies>
			<dependency key="channel" source="channel"/>
			<dependency key="executor" source="executor"/>
		</dependencies>
		<categories priority="DEBUG">
			<category name="/glue"/>
		</categories>
	</component>

	<component
		name="tuplemapper"
		class="org.pgj.tools.tuplemapper.impl.reflected.ReflectedTupleMapper">
		<dependencies>
			<dependency key="classloader" source="classloader"/>
		</dependencies>
		<categories priority="DEBUG">
			<category name="/tuplemapper"/>
		</categories>
		<configuration>
			<relation name="plj_testtable" class="org.deadcat_enterprises.TestTableRecord"/>
		</configuration>
	</component>

	<component
		name="log4j-init"
		class="org.pgj.tools.log4j.Log4jInitComponent">
		<dependencies>
		</dependencies>
		<categories priority="DEBUG">
		</categories>
		<configuration>
			<properties>
				<!--
				The root logger is the PLJAppender, so all log categories
				not configured here will go to RDBMS (or at least try to go there)
				-->
				<property name="log4j.rootLogger" value="INFO, plj"/>
				<property name="log4j.appender.plj" value="org.pgj.tools.log4j.PLJAppender"/>
				<property name="log4j.appender.plj.layout" value="org.apache.log4j.PatternLayout"/>
				<property name="log4j.appender.plj.layout.conversionPattern" value=" %d [%t] %-5p %c{1} - %m%n"/>
				
				<!--
				These entries are for the PostgreSQL typemapper`s 
				Field implementations. (it uses log4j). Its logs should remain
				local.
				-->
				
			</properties>
		</configuration>
	</component>

</container>